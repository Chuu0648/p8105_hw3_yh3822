---
title: "p8105_hw3_yh3822"
output: github_document
date: "2024-10-12"
---

```{r set up}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
library(tidyverse)
library(readxl)
library(dplyr)
library(p8105.datasets)
library(gridExtra)
```


## Problem 1

```{r}
data("ny_noaa")
str(ny_noaa)
summary(ny_noaa)
```


```{r}
missing_data_summary = ny_noaa %>%
  summarize(
    missing_tmax = mean(is.na(tmax)),
    missing_tmin = mean(is.na(tmin)),
    missing_prcp = mean(is.na(prcp)),
    missing_snow = mean(is.na(snow)),
    missing_snwd = mean(is.na(snwd ))
  )
missing_data_summary
```

This dataset contains the weather data of New York state weather stations from January 1, 1981 through December 31, 2010, including seven variables, which are id, date, prcp, snow, snwd, tmax, and tmin. Among them, "prcp" means the precipitation (tenths of mm), "snow" means the snowfall (mm), "snwd" means the depth of snow (mm), "tmax" means the maximum temperature (tenths of degrees C), and "tmin" means the minimum temperature (tenths of degrees C). There are totally `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. We found out that about 43.7 percent of the "tmin" and "tmax" are missing, which would seriously affect the analysis of temperatures and it's a big issue.




```{r}
ny_noaa$id = as.factor(ny_noaa$id)
ny_noaa$tmin = as.numeric(ny_noaa$tmin)
ny_noaa$tmax = as.numeric(ny_noaa$tmax)
ny_noaa_clean = ny_noaa %>%
  janitor::clean_names() %>%
  filter(!is.na(tmax), !is.na(tmin)) %>%
  mutate(
    year = year(date),
    month = month(date),
    day = day(date)
  )
```


```{r}
ny_noaa_clean = ny_noaa_clean %>%
  mutate(
    tmax = tmax / 10,    
    tmin = tmin / 10, 
    prcp = prcp / 10
  )
```



```{r}
ny_noaa_clean |>
  count(snow, sort = TRUE)
```

For snowfall, 0 is the most commonly observed value, followed by NA value and 25. It's because snow does not fall for most of the year.



```{r}
ny_noaa_clean |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month) |>
  summarize(mean_tmax = mean(tmax), na.rm = TRUE) |>
  ggplot(aes(x = year, y = mean_tmax)) +
  geom_point(alpha = 0.3) + 
  geom_line() +
  facet_grid(~ month) +
  labs(
    title = "Average Maximum Temperature in January and July",
    x = "Year",
    y = "Average Maximum Temperature (C)"
  ) +
  theme_minimal()
```

From the graph we can clearly see that the average maximum temperatures in January are basically in the range of -10 to 10 degrees Celsius, while the average maximum temperatures in July are almost in the range of 20 to 35 degrees Celsius, with a few notable outliers in both graphs.


```{r}
tmax_tmin_plot = ggplot(ny_noaa_clean, aes(x = tmin, y = tmax)) +
  geom_bin_2d() + 
  labs(
    title = "tmax vs tmin",
    x = "Minimum Temperature (C)",
    y = "Maximum Temperature (C)"
  ) +
  theme_minimal()
```



```{r}
snowfall_plot_data <- ny_noaa_clean %>%
  filter(snow > 0, snow < 100)
snowfall_plot = ggplot(snowfall_plot_data, aes(x = snow)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "white") +
  facet_wrap(~ year) +
  labs(
    title = "Distribution of Snowfall by Year",
    x = "Snowfall (mm)",
    y = "Count"
  ) +
  theme_minimal()
```


```{r}
grid.arrange(tmax_tmin_plot, snowfall_plot, ncol = 2)
```


## Problem 2


```{r, message=FALSE, warning=FALSE}
nhanes_accel_df = read_csv("./data/nhanes_accel.csv") 
nhanes_covar_df = read_csv("./data/nhanes_covar.csv", skip = 4)
```



```{r}
nhanes_accel_clean = nhanes_accel_df %>%
  janitor::clean_names() %>%
  mutate(across(starts_with("min"), ~ round(., 2)))
nhanes_covar_clean = nhanes_covar_df %>%
  janitor::clean_names() %>%
  mutate(sex = factor(sex, level = c(1, 2), labels = c("male", "female")),
                      education = factor(education, 
                                         levels = c(1, 2, 3), 
                                         labels = c("Less than high school", "High school equivalent", "More than high school"))
                      ) %>%
  drop_na(seqn, sex, age, bmi, education)
```




```{r}
nhanes_merged_df = nhanes_covar_clean %>%
  left_join(nhanes_accel_clean, by = "seqn") %>%
  filter(age >= 21)
```




```{r, message=FALSE, warning=FALSE}
nhanes_merged_df |>
  group_by(education, sex) |>
  summarise(count = n()) |>
  pivot_wider(
    names_from = sex,
    values_from = count
  )
```

27 males and 28 females are less than high school, 35 males and 23 females have the education of high school, 56 males and 59 females are more than high school.



```{r}
nhanes_merged_df %>%
  ggplot(aes(x = education, y = age, fill = sex)) +
  geom_violin(alpha = 0.7) +
  facet_grid(~sex) +  
  labs(
    title = "Age Distribution by Education Level and Sex",
    x = "Education Level",
    y = "Age"
    ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

As can be seen from the plot, the age distribution is less homogeneous at all levels of education, for both men and women. For those with less than a high school education, the highest concentration of males is in the 50s and 70s, and the number of females increases with age up to the 70s. In the case of high school education, the highest concentration of males is in the 30s and 60s, and the number of females increases with age up to the 70s. For those with more than high school education, it is clear that there are more men and women in their 30s.



```{r}
nhanes_merged_df %>%
  rowwise() %>%
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "lm", se = FALSE, alpha = 0.3) +  
  facet_grid(~ education) +  
  labs(
    title = "Total Activity vs Age by Sex and Education Level",
    x = "Age",
    y = "Total Activity"
  ) +
  theme_minimal()
```

We found that total activity decreased progressively with age for both males and females, and this trend was most significant for those with less than a high school education. In addition, for high school and higher than high school education, men's total activity was largely lower than women's total activity.



```{r}
nhanes_merged_df %>%
  pivot_longer(
    cols = starts_with("min"), 
    names_to = "minute", 
    values_to = "activity"
    ) %>%
  mutate(minute = as.numeric(gsub("min", "", minute))) %>%
  ggplot(aes(x = minute, y = activity, color = sex)) +
  geom_smooth(se = FALSE) +  
  facet_wrap(~ education) +  
  labs(
    title = "24-hour Activity Time Courses by Education Level",
    x = "Minute of the Day",
    y = "Activity"
  ) +
  theme_minimal()
```

Regardless of gender, the general trend in the distribution of activity in a day for each educational level is similar, with a downward trend at the beginning to 250 minutes, a rapid rise at that to 500 minutes, more volatile up to about 1200 minutes, and a straight line down from 1200 minutes to the end. Except for educational levels below the high school level, women have higher activity levels than men from 500 to 1200 minutes.


## Problem 3

```{r, message=FALSE, warning=FALSE}
jan_2020_citi = read_csv("./data/citibike/Jan 2020 Citi.csv")
jan_2024_citi = read_csv("./data/citibike/Jan 2024 Citi.csv")
july_2020_citi = read_csv("./data/citibike/July 2020 Citi.csv")
july_2024_citi = read_csv("./data/citibike/July 2024 Citi.csv")
```



```{r}
jan_2020_clean = jan_2020_citi %>%
  janitor::clean_names() %>%
  mutate(rideable_type = as.factor(rideable_type)) %>%
  mutate(weekdays = as.factor(weekdays)) %>%
  mutate(member_casual = as.factor(member_casual)) %>%
  mutate(duration = round(duration, 2)) %>%
  mutate(year = 2020, month = "January")
```



```{r}
jan_2024_clean = jan_2024_citi %>%
  janitor::clean_names() %>%
  mutate(rideable_type = as.factor(rideable_type)) %>%
  mutate(weekdays = as.factor(weekdays)) %>%
  mutate(member_casual = as.factor(member_casual)) %>%
  mutate(duration = round(duration, 2)) %>%
  mutate(year = 2024, month = "January")
```


```{r}
july_2020_clean = july_2020_citi %>%
  janitor::clean_names() %>%
  mutate(rideable_type = as.factor(rideable_type)) %>%
  mutate(weekdays = as.factor(weekdays)) %>%
  mutate(member_casual = as.factor(member_casual)) %>%
  mutate(duration = round(duration, 2)) %>%
  mutate(year = 2020, month = "July")
```


```{r}
july_2024_clean = july_2024_citi %>%
  janitor::clean_names() %>%
  mutate(rideable_type = as.factor(rideable_type)) %>%
  mutate(weekdays = as.factor(weekdays)) %>%
  mutate(member_casual = as.factor(member_casual)) %>%
  mutate(duration = round(duration, 2)) %>%
  mutate(year = 2024, month = "July")
```


These four datasets contain contains data on rides taken on the NYC Citi Bike system for January 2020, July 2020, January 2024, July 2024. The dataset for January 2020 has `r nrow(jan_2020_clean)` rows and `r ncol(jan_2020_clean)` columns, January 2024 has `r nrow(jan_2024_clean)` rows and `r ncol(jan_2024_clean)` columns, July 2024 has `r nrow(july_2020_clean)` rows and `r ncol(july_2020_clean)` columns, July 2024 has `r nrow(july_2024_clean)` rows and `r ncol(july_2024_clean)` columns. They have the same variables, which are "ride_id", "rideable_type", "weekdays", "duration", "start_station_name", "end_station_name", "member_casual", "year", and "month".


```{r}
citibike_merged = bind_rows(jan_2020_clean, july_2020_clean, jan_2024_clean, july_2024_clean)
```



```{r}
citibike_merged %>%
  group_by(year, month, member_casual) |>
  summarise(total_rides = n(), .groups = "drop") |>
  pivot_wider(
    names_from = member_casual,
    values_from = total_rides
  )
```

There were 984 casual riders and 11436 member riders rent the bike on January 2020, 5637 casual riders and 15411 member riders rent the bike on July 2020, 2108 casual riders and 16753 member riders rent the bike on January 2024, 10894 casual riders and 36262 member riders rent the bike on July 2024. Among them, the number of the member riders were always larger than the number of the casual riders.



